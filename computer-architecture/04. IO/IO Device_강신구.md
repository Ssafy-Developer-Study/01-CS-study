# 8. 입출력 장치

## 1 ) 장치 컨트롤러와 장치 드라이버

1. 장치 컨트롤러
    1. 입출력 장치는 컴퓨터에 직접 연결되지 않고 장치 컨트롤러라는 하드웨어를 통해 연결된다.
        1. 입출력 장치에는 종류가 너무 많아 규격화하기 어렵다.
        2. CPU / 메모리의 데이터 전송률의 차이로 통신을 어렵게 한다.
    2. 컨트롤러의 역할
        1. CPU와 입출력장치 간의 통신 중계
        2. 오류 검출
        3. 데이터 버퍼링
            - 버퍼링(Buffering)이란 전송률이 높은 장치와 낮은 장치 사이에 주고 받는 데이터를 버퍼(buffer)라는 임시 저장 공간에 저장하여 전송률을 비슷하게 맞추는 방법
    3. 내부
        
        ![Untitled](https://prod-files-secure.s3.us-west-2.amazonaws.com/ccd9570b-85c2-4c37-a7ea-3521eb1cd311/969a7df6-bcdc-43bd-8c6f-c55945a23148/Untitled.png)
        
        1. 데이터 레지스터
            - CPU와 입출력 장치 사이에 주고 받을 데이터가 담기는 레지스터
            - 버퍼 역할을 수행
        2. 상태 레지스터
            - 입출력 장치가 입출력 작업을 할 준비가 되었는지, 입출력 작업이 완료되었는지, 오류는 없는지 등의 상태 정보를 저장
        3. 제어 레지스터
            - 입출력 장치가 수행할 내용에 대한 제어 정보와 명령을 저장
2. 장치 드라이버
    1. 장치 컨트롤러의 동작을 감지하고 제어함으로써 장치 컨트롤러가 컴퓨터 내부와 정보를 주고 받을 수 있게 하는 프로그램
    2. 새로운 장치를 컴퓨터에 연결하려면 장치 드라이버를 설치해야 한다.
    3. 장치 컨트롤러가 입출력 장치를 연결하기 위한 하드웨어적인 통로라면, 장치 드라이버는 입출력 장치를 연결하기 위한 소프트웨어적인 통로이다.

## 2 ) 다양한 입출력 방법

1. 프로그램 입출력
    1. 기본적으로 프로그램 속 명령어로 입출력 장치를 제어하는 방법
    2. CPU의 입출력 작업
        1. CPU는 하드 디스크 컨트롤러의 제어 레지스터에 쓰기 명령을 보낸다.
        2. 하드 디스크 컨트롤러는 하드 디스크의 상태를 확인한다.
            - 준비된 상태하면 상태 레지스터에 준비되었다고 표시한다.
        3. CPU는 상태 레지스터를 주기적으로 읽어보며 하드 디스크의 준비 여부를 확인한다.
            - 준비된 것을 확인하면 메모리의 정보를 데이터 레지스터에 쓴다.
    3. 메모리 맵 입출력
        1. 메모리에 접근하기 위한 주소 공간과 입출력 장치에 접근하기 위한 주소 공간을 하나의 주소 공간으로 간주하는 방법
            - 메모리의 주소들이나 장치 컨트롤러의 레지스터들이나 모두 똑같이 메모리 주소를 대하듯 하면 된다.
    4. 고립형 입출력
        1. 메모리를 위한 주소 공간과 입출력 장치를 위한 주소 공간을 분리하는 방법
        2. 만약 1024개의 주소 공간이 있고, 제어 버스에 ‘메모리 읽기/쓰기’선과 ‘입출력장치 읽기/쓰기’선이 있다고 하자.
            
            ![Untitled](https://prod-files-secure.s3.us-west-2.amazonaws.com/ccd9570b-85c2-4c37-a7ea-3521eb1cd311/93dd97e3-c52e-4475-82d3-2b36a8a5b3c0/Untitled.png)
            
        3. 그렇다면 메모리에도 1024개의 주소 공간을 활용할 수 있고, 입출력 장치도 1024개의 주소 공간을 활용할 수 있다.
            - ‘메모리 읽기/쓰기’ 시 에는 메모리에 접근하고, ‘입출력장치 읽기/쓰기’ 시 에는 장치 컨트롤러에 접근하기 떄문이다.
        4. 즉, 메모리에 접근하는 명령어와 입출력 장치에 접근하는 명령어가 다르다.
            - 메모리 맵 입출력과 대조적이다.
                
                ![Untitled](https://prod-files-secure.s3.us-west-2.amazonaws.com/ccd9570b-85c2-4c37-a7ea-3521eb1cd311/63ec8bd3-a774-4a36-99b9-f2d85a1e506c/Untitled.png)
                
2. 인터럽트 기반 입출력
    1. 입출력 장치에 의한 하드웨어 인터럽트는 입출력 장치가 아닌 장치 컨트롤러에 의해 발생한다.
    2. CPU는 장치 컨트롤러에 입출력 작업을 명령하고, 장치 컨트롤러가 입출력 장치를 제어하며 입출력을 수행하는 동안 CPU는 다른 일을 수행할 수 있다.
    3. 장치 컨트롤러 입출력 작업을 끝낸 뒤 CPU에게 인터럽트 요청 신호를 보내면 CPU는 하던 일을 잠시 백업하고 인터럽트 서비스 루틴을 실행한다.
    4. CPU는 인터럽트 간에 우선순위를 고려하여 우선순위가 높은 인터럽트 순으로 여러 인터럽트를 처리할 수 있다.
    5. 인터럽트 비트
        1. 비활성화 된 경우
            - 인터럽트가 발생한 순서대로 처리한다.
        2. 활성화 된 경우 / 인터럽트 비트를 무시할 수 없는 인터럽트 NMI(Non-Mashable Interupt)가 발생한 경우
            - 우선순위가 높은 인터럽트부터 처리한다.
    6. 프로그래머블 인터럽트 컨트롤러(Programmable Interupt Controller, PIC)
        1. 장치 컨트롤러에서 보낸 하드웨어 인터럽트 요청들의 우선순위를 판별한 뒤 CPU에 지금 처리해야 할 하드웨어 인터럽트가 무엇인지 알려주는 장치
        2. 순서
            - PIC가 장치 컨트롤러에서 발생한 인터럽트 요청 신호를 받아들인다.
            - PIC는 인터럽트 우선순위를 판단한 뒤 CPU에 처리해야 할 인터럽트 요청 신호를 보낸다.
            - CPU는 PIC에 인터럽트 확인 신호를 보낸다.
            - PIC는 데이터 버스를 통해 CPU에 인터럽트 벡터를 보낸다.
            - CPU는 인터럽트 벡터를 통해 인터럽트 요청의 주체를 알게 되고, 해당 장치의 인터럽트 서비스 루틴을 실행한다.
        3. NMI는 우선 순위가 가장 높아 우선순위 판별이 불필요하기 때문에 PIC가 NMI까지 우선순위를 판별하지 않는다.
3. DMA(Direct Memory Access) 입출력
    1. 프로그램 기반 입출력과 인터럽트 기반 입출력의 공통점은 입출력 장치와 메모리 간의 데이터 이동은 CPU가 주도하고, 이동하는 데이터도 반드시 CPU를 거친다는 것이다.
    2. 이에 CPU의 부담을 줄이기 위해 CPU를 거치지 않고 상호작용할 수 있는 입출력 방식이 DMA이다.
    3. DMA는 메모리에 직접 접근할 수 있는 입출력 기능이다.
        - DMA 입출력을 하기 위해서는 시스템 버스에 연결된 DMA 컨트롤러라는 하드웨어가 필요하다.
    4. 순서
        1. CPU는 DMA 컨트롤러에 입출력 장치의 주소, 수행할 연산(읽기/쓰기), 읽거나 쓸 메모리의 주소 등과 같은 정보로 입출력 작업을 명령한다.
        2. DMA 컨트롤러는 CPU 대신 장치 컨트롤러와 상호작용하며 입출력 작업을 수행한다.
            - DMA 컨트롤러는 필요한 경우 메모리에 직접 접근하여 정보를 읽거나 쓴다.
        3. 입출력 작업이 끝나면 DMA 컨트롤러는 CPU에 인터럽트를 걸어 작업이 끝났음을 알립니다.
    5. 시스템 버스는 동시에 사용이 불가능하기 때문에 DMA 컨트롤러는 CPU가 시스템을 사용하지 않거나, 사용하겠다고 명시를 한 후 사용한다.
4. 입출력 버스
    1. DMA를 사용하여 메모리에 접근 시 시스템 버스를 두 번 사용하게 되는 부작용이 있다.
        
        ![Untitled](https://prod-files-secure.s3.us-west-2.amazonaws.com/ccd9570b-85c2-4c37-a7ea-3521eb1cd311/9fb2c171-b0f6-4341-8a55-08d2a73ad973/Untitled.png)
        
        - 메모리에서 DMA 컨트롤러로 데이터를 가져오기 위해서 한 번
        - DMA 컨트롤러의 데이터를 장치 컨트롤러 옮기기 위해서 한 번
    2. 시스템 버스를 너무 사용하면 CPU가 그만큼 시스템 버스를 사용하지 못한다.
    3. 이에 입출력 버스라는 별도의 버스를 구성하여 해결할 수 있다.
        
        ![Untitled](https://prod-files-secure.s3.us-west-2.amazonaws.com/ccd9570b-85c2-4c37-a7ea-3521eb1cd311/831a108b-a390-4ed4-b6bd-26d7365f0394/Untitled.png)
